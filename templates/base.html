<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static' , filename='css/eggy.css')}}" />
    <link rel="stylesheet" href="{{ url_for('static' , filename='css/progressbar.css')}}" />
    <link rel="stylesheet" href="{{ url_for('static' , filename='css/theme.css')}}" />
    <link rel="stylesheet" href="{{ url_for('static' , filename='css/index.css')}}">

    {% block header %}
    {% endblock %}
</head>
<body>

{% block body %}
{% endblock %}

<script>
    const prices = document.getElementsByClassName('price');
    for (let i = 0; i < prices.length; i++) {
        let price = prices[i];
        price.innerText = parseInt(price.innerText).toLocaleString() + ' تومان ';
    }
</script>

<script type="module">
  async function getEggy() {
    try {
      const mod = await import('{{ url_for("static", filename="js/eggy.js") }}');
      return mod.Eggy || mod.default || mod;
    } catch (e) {
      const cdn = "https://unpkg.com/@saucesteals/eggy@latest/dist/eggy.js";
      const mod = await import(cdn);
      return mod.Eggy || mod.default || mod;
    }
  }

  function forcePositionOnEggyContainer(position = 'top-right') {
    const possibleSelectors = [
      '.eggy__container',
      '.eggy-container',
      '.eggy_container',
      '.eggy-container-wrap',
      '.eggy'
    ];

    // 📍 تنظیم فاصله‌ها
    const cssMap = {
      'top-right': {
        top: '80px',     // ← فاصله از هدر (در صورت بلند بودن هدر می‌تونی این عدد رو زیاد کنی)
        right: '20px',
        left: 'auto',
        bottom: 'auto',
        transform: 'none'
      },
      'top-center': {
        top: '80px',
        left: '50%',
        transform: 'translateX(-50%)',
        right: 'auto',
        bottom: 'auto'
      }
    };

    for (const sel of possibleSelectors) {
      const el = document.querySelector(sel);
      if (el) {
        const css = cssMap[position] || cssMap['top-right'];
        el.style.position = 'fixed';
        el.style.zIndex = '999999';
        Object.keys(css).forEach(k => el.style[k] = css[k]);
        return true;
      }
    }
    return false;
  }

  function showFallbackToast(message, duration = 5000) {
    const id = 'fallback-toast';
    let container = document.getElementById(id);
    if (!container) {
      container = document.createElement('div');
      container.id = id;
      container.style.position = 'fixed';
      container.style.top = '80px';   // فاصله از هدر
      container.style.right = '20px';
      container.style.zIndex = '1000000';
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.gap = '8px';
      document.body.appendChild(container);
    }

    const box = document.createElement('div');
    box.textContent = message;
    box.style.padding = '10px 14px';
    box.style.borderRadius = '8px';
    box.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
    box.style.background = '#ffffff';
    box.style.direction = 'rtl';
    box.style.fontSize = '14px';
    box.style.color = '#111';
    container.appendChild(box);

    setTimeout(() => {
      box.style.transition = 'opacity .4s, transform .4s';
      box.style.opacity = '0';
      box.style.transform = 'translateY(-10px)';
    }, duration - 400);

    setTimeout(() => box.remove(), duration);
  }

  (async () => {
    const Eggy = await getEggy();
    const useEggy = typeof Eggy === 'function' || (typeof Eggy === 'object' && Eggy !== null);

    // 👇 محل نمایش: بالا سمت راست
    const desiredPosition = 'top-right';

    {% for m in get_flashed_messages() %}
      try {
        if (useEggy) {
          try {
            Eggy({
              title: 'پیام سیستم',
              message: `{{ m | safe }}`,
              type: 'info',
              duration: 5000,
              options: { position: desiredPosition }
            });
          } catch(e) {
            try {
              Eggy('پیام سیستم', `{{ m | safe }}`, { duration: 5000, position: desiredPosition });
            } catch (err) {
              showFallbackToast(`{{ m | safe }}`, 5000);
            }
          }

          setTimeout(() => {
            const ok = forcePositionOnEggyContainer(desiredPosition);
            if (!ok) showFallbackToast(`{{ m | safe }}`, 5000);
          }, 100);
        } else {
          showFallbackToast(`{{ m | safe }}`, 5000);
        }
      } catch (outerErr) {
        showFallbackToast(`{{ m | safe }}`, 5000);
      }
    {% endfor %}
  })();
</script>


</body>
</html>
